<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Mostlylucid.ImageSummarizer.Desktop.ViewModels"
        x:Class="Mostlylucid.ImageSummarizer.Desktop.MainWindow"
        x:DataType="vm:MainViewModel"
        Title="Image Summarizer"
        Width="900" Height="700"
        MinWidth="600" MinHeight="500"
        WindowStartupLocation="CenterScreen"
        DragDrop.AllowDrop="True">

    <Window.Styles>
        <Style Selector="TextBlock.header">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>
        <Style Selector="Button.primary">
            <Setter Property="Background" Value="{DynamicResource SystemAccentColor}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="16,8"/>
        </Style>
        <Style Selector="ComboBox">
            <Setter Property="MinWidth" Value="120"/>
        </Style>
    </Window.Styles>

    <Grid RowDefinitions="Auto,*,Auto" Margin="16">
        <!-- Header with controls and status indicators -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
            <!-- Left: Controls -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                <Button Command="{Binding BrowseCommand}"
                        CommandParameter="{Binding $parent[Window].StorageProvider}"
                        Classes="primary">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <PathIcon Data="M19,20H4C2.89,20 2,19.1 2,18V6C2,4.89 2.89,4 4,4H10L12,6H19A2,2 0 0,1 21,8H21L4,8V18L6.14,10H23.21L20.93,18.5C20.7,19.37 19.92,20 19,20Z"
                                  Width="14" Height="14"/>
                        <TextBlock Text="Browse"/>
                    </StackPanel>
                </Button>

                <ComboBox ItemsSource="{Binding Pipelines}"
                          SelectedItem="{Binding SelectedPipeline}"
                          ToolTip.Tip="Analysis pipeline"/>

                <ComboBox ItemsSource="{Binding OutputFormats}"
                          SelectedItem="{Binding SelectedOutput}"
                          ToolTip.Tip="Output format"/>

                <CheckBox Content="LLM"
                          IsChecked="{Binding EnableVisionLlm}"
                          VerticalAlignment="Center"
                          ToolTip.Tip="Enable Vision LLM for captions"/>

                <ComboBox ItemsSource="{Binding AvailableModels}"
                          SelectedItem="{Binding VisionModel}"
                          IsVisible="{Binding EnableVisionLlm}"
                          ToolTip.Tip="Vision model"/>

                <Button Command="{Binding AnalyzeCommand}"
                        IsEnabled="{Binding !IsProcessing}"
                        Classes="primary">
                    <TextBlock Text="Analyze"/>
                </Button>
            </StackPanel>

            <!-- Right: Status indicators (compact) -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="4" ToolTip.Tip="{Binding OcrStatus}">
                    <Ellipse Width="8" Height="8" Fill="{Binding OcrStatusColor}"/>
                    <TextBlock Text="OCR" FontSize="10" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="4" ToolTip.Tip="{Binding OpenCvStatus}">
                    <Ellipse Width="8" Height="8" Fill="{Binding OpenCvStatusColor}"/>
                    <TextBlock Text="CV" FontSize="10" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="4" ToolTip.Tip="{Binding OllamaStatus}">
                    <Ellipse Width="8" Height="8" Fill="{Binding OllamaStatusColor}"/>
                    <TextBlock Text="LLM" FontSize="10" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="1" ColumnDefinitions="*,16,*">
            <!-- Left: Image Preview -->
            <Border Grid.Column="0"
                    Background="{DynamicResource SystemControlBackgroundAltMediumLowBrush}"
                    BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="8"
                    Name="DropZone">
                <Grid>
                    <!-- Drop hint when no image -->
                    <StackPanel VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                IsVisible="{Binding ImagePreview, Converter={x:Static ObjectConverters.IsNull}}">
                        <PathIcon Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"
                                  Width="48" Height="48"
                                  Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                        <TextBlock Text="Drop image here"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumHighBrush}"
                                   Margin="0,16,0,0"/>
                        <TextBlock Text="or click Browse"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                   FontSize="12"/>
                    </StackPanel>

                    <!-- Image preview -->
                    <Image Source="{Binding ImagePreview}"
                           Stretch="Uniform"
                           IsVisible="{Binding ImagePreview, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                </Grid>
            </Border>

            <!-- Right: Results -->
            <Grid Grid.Column="2" RowDefinitions="Auto,*,Auto">
                <TextBlock Grid.Row="0" Text="Result" Classes="header"/>

                <TextBox Grid.Row="1"
                         Text="{Binding ResultText}"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         IsReadOnly="True"
                         FontFamily="Cascadia Code, Consolas, monospace"
                         FontSize="13"
                         Padding="12"
                         CornerRadius="8"/>

                <Button Grid.Row="2"
                        Command="{Binding CopyToClipboardCommand}"
                        CommandParameter="{Binding $parent[Window].Clipboard}"
                        HorizontalAlignment="Right"
                        Margin="0,8,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <PathIcon Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                                  Width="14" Height="14"/>
                        <TextBlock Text="Copy"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Grid>

        <!-- Footer / Status -->
        <Border Grid.Row="2"
                Background="{DynamicResource SystemControlBackgroundAltMediumLowBrush}"
                CornerRadius="4"
                Padding="12,6"
                Margin="0,12,0,0">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="{Binding StatusText}" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding FallbackMode}" FontSize="11" FontStyle="Italic"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Ollama URL (collapsed by default) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" IsVisible="{Binding EnableVisionLlm}">
                    <TextBlock Text="Ollama:" VerticalAlignment="Center" FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                    <TextBox Text="{Binding OllamaUrl}"
                             Width="180"
                             FontSize="11"
                             Padding="4,2"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
